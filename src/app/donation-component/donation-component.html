<div class="donation-container">
  <div class="donation-header">
    <button class="back-button" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      Voltar
    </button>
    <h1 class="page-title">Faça sua Doação</h1>
  </div>

  <div class="donation-content">
    <!-- Formulário de Doação -->
    @if (!showQRCode()) {
    <div class="donation-form-section">
      <div class="form-card">
        <h2 class="section-title">Informações para Doação</h2>
        <p class="section-description">
          Preencha os dados abaixo para gerar o QR Code de pagamento via PIX
        </p>
        
        @if (selectedNGO()) {
          <div class="selected-ngo-info">
            <div class="ngo-badge">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <span>Doando para: <strong>{{ selectedNGO().name }}</strong></span>
            </div>
          </div>
        }

        <form [formGroup]="donationForm" (ngSubmit)="onSubmit()" class="donation-form">
          <div class="form-group">
            <label for="name">Nome Completo *</label>
            <input 
              type="text" 
              id="name"
              formControlName="name"
              class="form-input"
              [class.error]="donationForm.get('name')?.invalid && donationForm.get('name')?.touched"
              placeholder="Digite seu nome completo">
            @if (donationForm.get('name')?.invalid && donationForm.get('name')?.touched) {
            <div class="error-message">
              @if (donationForm.get('name')?.errors?.['required']) {
              <span>Nome é obrigatório</span>
              }
              @if (donationForm.get('name')?.errors?.['minlength']) {
              <span>Nome deve ter pelo menos 3 caracteres</span>
              }
            </div>
            }
          </div>

          <!-- Seção de Endereço -->
          <div class="address-section">
            <h3 class="address-section-title">Endereço</h3>
            
            <div class="form-row">
              <div class="form-group form-group-large">
                <label for="street">Rua *</label>
                <input 
                  type="text" 
                  id="street"
                  formControlName="street"
                  class="form-input"
                  [class.error]="donationForm.get('street')?.invalid && donationForm.get('street')?.touched"
                  placeholder="Nome da rua">
                @if (donationForm.get('street')?.invalid && donationForm.get('street')?.touched) {
                <div class="error-message">
                  @if (donationForm.get('street')?.errors?.['required']) {
                  <span>Rua é obrigatória</span>
                  }
                  @if (donationForm.get('street')?.errors?.['minlength']) {
                  <span>Rua deve ter pelo menos 3 caracteres</span>
                  }
                </div>
                }
              </div>
              
              <div class="form-group form-group-small">
                <label for="number">Número *</label>
                <input 
                  type="text" 
                  id="number"
                  formControlName="number"
                  class="form-input"
                  [class.error]="donationForm.get('number')?.invalid && donationForm.get('number')?.touched"
                  placeholder="123">
                @if (donationForm.get('number')?.invalid && donationForm.get('number')?.touched) {
                <div class="error-message">
                  @if (donationForm.get('number')?.errors?.['required']) {
                  <span>Número é obrigatório</span>
                  }
                </div>
                }
              </div>
            </div>

            <div class="form-group">
              <label for="complement">Complemento</label>
              <input 
                type="text" 
                id="complement"
                formControlName="complement"
                class="form-input"
                placeholder="Apartamento, bloco, etc. (opcional)">
            </div>

            <div class="form-row">
              <div class="form-group form-group-medium">
                <label for="neighborhood">Bairro *</label>
                <input 
                  type="text" 
                  id="neighborhood"
                  formControlName="neighborhood"
                  class="form-input"
                  [class.error]="donationForm.get('neighborhood')?.invalid && donationForm.get('neighborhood')?.touched"
                  placeholder="Nome do bairro">
                @if (donationForm.get('neighborhood')?.invalid && donationForm.get('neighborhood')?.touched) {
                <div class="error-message">
                  @if (donationForm.get('neighborhood')?.errors?.['required']) {
                  <span>Bairro é obrigatório</span>
                  }
                  @if (donationForm.get('neighborhood')?.errors?.['minlength']) {
                  <span>Bairro deve ter pelo menos 2 caracteres</span>
                  }
                </div>
                }
              </div>

              <div class="form-group form-group-medium">
                <label for="city">Cidade *</label>
                <input 
                  type="text" 
                  id="city"
                  formControlName="city"
                  class="form-input"
                  [class.error]="donationForm.get('city')?.invalid && donationForm.get('city')?.touched"
                  placeholder="Nome da cidade">
                @if (donationForm.get('city')?.invalid && donationForm.get('city')?.touched) {
                <div class="error-message">
                  @if (donationForm.get('city')?.errors?.['required']) {
                  <span>Cidade é obrigatória</span>
                  }
                  @if (donationForm.get('city')?.errors?.['minlength']) {
                  <span>Cidade deve ter pelo menos 2 caracteres</span>
                  }
                </div>
                }
              </div>
            </div>

            <div class="form-row">
              <div class="form-group form-group-small">
                <label for="state">Estado (UF) *</label>
                <input 
                  type="text" 
                  id="state"
                  formControlName="state"
                  class="form-input"
                  [class.error]="donationForm.get('state')?.invalid && donationForm.get('state')?.touched"
                  placeholder="SP"
                  maxlength="2"
                  (input)="onStateInput($event)">
                @if (donationForm.get('state')?.invalid && donationForm.get('state')?.touched) {
                <div class="error-message">
                  @if (donationForm.get('state')?.errors?.['required']) {
                  <span>Estado é obrigatório</span>
                  }
                  @if (donationForm.get('state')?.errors?.['minlength'] || donationForm.get('state')?.errors?.['maxlength']) {
                  <span>Estado deve ter 2 caracteres</span>
                  }
                </div>
                }
              </div>

              <div class="form-group form-group-medium">
                <label for="zipCode">CEP *</label>
                <input 
                  type="text" 
                  id="zipCode"
                  formControlName="zipCode"
                  class="form-input"
                  [class.error]="donationForm.get('zipCode')?.invalid && donationForm.get('zipCode')?.touched"
                  placeholder="00000-000"
                  maxlength="9"
                  (input)="onZipCodeInput($event)">
                @if (donationForm.get('zipCode')?.invalid && donationForm.get('zipCode')?.touched) {
                <div class="error-message">
                  @if (donationForm.get('zipCode')?.errors?.['required']) {
                  <span>CEP é obrigatório</span>
                  }
                  @if (donationForm.get('zipCode')?.errors?.['invalidZipCode']) {
                  <span>CEP inválido (deve ter 8 dígitos)</span>
                  }
                </div>
                }
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="cpf">CPF *</label>
            <input 
              type="text" 
              id="cpf"
              formControlName="cpf"
              class="form-input"
              [class.error]="donationForm.get('cpf')?.invalid && donationForm.get('cpf')?.touched"
              placeholder="000.000.000-00"
              (input)="onCPFInput($event)"
              maxlength="14">
            @if (donationForm.get('cpf')?.invalid && donationForm.get('cpf')?.touched) {
            <div class="error-message">
              @if (donationForm.get('cpf')?.errors?.['required']) {
              <span>CPF é obrigatório</span>
              }
              @if (donationForm.get('cpf')?.errors?.['invalidCpf']) {
              <span>CPF inválido</span>
              }
            </div>
            }
          </div>

          <div class="form-group">
            <label for="amount">Valor da Doação (R$) *</label>
            <input 
              type="text" 
              id="amount"
              formControlName="amount"
              class="form-input"
              [class.error]="donationForm.get('amount')?.invalid && donationForm.get('amount')?.touched"
              placeholder="0,00"
              (input)="onAmountInput($event)">
            @if (donationForm.get('amount')?.invalid && donationForm.get('amount')?.touched) {
            <div class="error-message">
              @if (donationForm.get('amount')?.errors?.['required']) {
              <span>Valor é obrigatório</span>
              }
              @if (donationForm.get('amount')?.errors?.['invalidAmount']) {
              <span>Valor inválido</span>
              }
              @if (donationForm.get('amount')?.errors?.['min']) {
              <span>Valor deve ser maior que zero</span>
              }
            </div>
            }
          </div>

          <button type="submit" class="submit-button" [disabled]="donationForm.invalid">
            Gerar QR Code para Pagamento
          </button>
        </form>
      </div>
    </div>
    }

    <!-- QR Code Section -->
    @if (showQRCode()) {
    <div class="qr-code-section" id="qr-code-section">
      <div class="qr-card">
        <div class="qr-header">
          <h2 class="section-title">QR Code para Pagamento</h2>
          <p class="section-description">
            Escaneie o QR Code com o aplicativo do seu banco para realizar o pagamento via PIX
          </p>
        </div>

        <div class="qr-code-container">
          <div class="qr-code-wrapper">
            <!-- QR Code Mockado -->
            <div class="qr-code-mock">
              <div class="qr-pattern">
                <!-- Padrão que simula um QR Code -->
                <div class="qr-square top-left"></div>
                <div class="qr-square top-right"></div>
                <div class="qr-square bottom-left"></div>
                <div class="qr-grid">
                  @for (row of qrCodePattern(); track $index) {
                    <div class="qr-row">
                      @for (cell of row; track $index) {
                        <div class="qr-cell" [class.filled]="cell"></div>
                      }
                    </div>
                  }
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="qr-info">
          <div class="info-item">
            <span class="info-label">Código PIX:</span>
            <span class="info-value">00020126580014BR.GOV.BCB.PIX01360e37f561-8739-42e9-a54f-f42878dbfa9f5204000053039865802BR5920Arthur Meireles Dias6009SAO PAULO62140510Fltyl6OPrA63048FF8</span>
          </div>
          <div class="info-item">
            <span class="info-label">Valor:</span>
            <span class="info-value">R$ {{ donationAmount().toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Método:</span>
            <span class="info-value">PIX</span>
          </div>
        </div>

        <div class="qr-actions">
          <button class="action-button secondary" (click)="downloadQRCode()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Baixar QR Code
          </button>
          <button class="action-button primary" (click)="printQRCode()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
            </svg>
            Imprimir
          </button>
        </div>

        <div class="success-message">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>QR Code gerado com sucesso! Escaneie com o app do seu banco.</p>
        </div>
      </div>
    </div>
    }
  </div>
</div>

